<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exclusive Comfort â€” Luxe Products</title>
<style>
  :root{
    --blue:#0C2C7A; --blue-pop:#2C6DFF; --gold:#E6B652; --gold2:#B98A2F;
    --ink:#0E0E0E; --muted:#4B4A46; --r:24px; --shadow:0 60px 140px rgba(12,44,122,.28);
    --bg: radial-gradient(1200px 780px at 50% 8%, #ffffff 0%, #ffffff 55%, rgba(12,44,122,.08) 75%, rgba(12,44,122,.16) 100%);
  }
  html,body{
    height:100%;margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);color:var(--ink)
  }
  .wrap{max-width:1240px;margin:0 auto;padding:clamp(16px,4vw,32px)}
  header{display:grid;gap:8px;justify-items:center;text-align:center;margin-bottom:clamp(12px,2vw,18px)}
  h1{
    font-family:"Playfair Display",ui-serif,Georgia,serif;
    font-weight:600;color:var(--blue);
    font-size:clamp(28px,5vw,48px);margin:0
  }
  .lead{max-width:880px;color:var(--muted);line-height:1.75;margin:0}

  /* Search */
  .search-row{
    max-width:480px;
    margin:14px auto 4px;
  }
  .search-input{
    width:100%;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(12,44,122,.16);
    background:#fff;
    font-size:14px;
    box-shadow:0 10px 26px rgba(12,44,122,.12);
    outline:none;
  }
  .search-input::placeholder{color:#9a9a96;}

  /* Filters */
  .filters{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0 6px}
  .chip{
    padding:10px 14px;border-radius:999px;
    border:1px solid rgba(12,44,122,.16);
    background:linear-gradient(#fff,#F4F7FF);
    cursor:pointer;font-size:13px;
    transition:box-shadow .2s ease,border-color .2s ease,transform .1s ease;
  }
  .chip:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(12,44,122,.18)}
  .chip[aria-pressed="true"]{border-color:var(--gold);box-shadow:0 8px 22px rgba(185,138,47,.24)}

  /* Product grid */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
    gap:clamp(8px,2vw,14px);
    min-height:120px;
  }
  @media(min-width:980px){
    .grid{grid-template-columns:repeat(auto-fill,minmax(190px,1fr));}
  }
  .grid-empty{
    grid-column:1/-1;
    text-align:center;
    padding:40px 16px;
    color:var(--muted);
    font-size:14px;
  }
  .card{
    position:relative;border-radius:18px;overflow:hidden;
    background:#fff;border:1px solid rgba(12,44,122,.12);
    box-shadow:0 14px 36px rgba(12,44,122,.14);
    transition:transform .12s ease, box-shadow .28s ease;
    cursor:pointer;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 22px 60px rgba(12,44,122,.22)}
  .thumb{
    position:relative;aspect-ratio:1/1;
    background:#f4f6fa;
    overflow:hidden;
  }
  .thumb img{
    position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;object-position:center;
  }
  .thumb.placeholder{
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    text-align:center;padding:10px;
    background:radial-gradient(circle at 0 0, rgba(230,182,82,.28), rgba(12,44,122,.05));
    color:#6f6f6f;font-size:11px;font-weight:500;
  }
  .thumb.placeholder span{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    border:1px dashed rgba(12,44,122,.25);
    background-color:rgba(255,255,255,.7);
  }
  .strip{position:absolute;top:0;left:0;right:0;height:5px;background:#0C2C7A}
  .body{padding:10px 12px}
  .name{font-weight:700;color:var(--blue);letter-spacing:.2px;font-size:clamp(13px,2.6vw,15px);line-height:1.35}
  .price{font-weight:750;margin-top:4px;font-size:clamp(12px,2.4vw,14px);color:#2A2A2A;opacity:.95}
  .cta-row{display:flex;gap:6px;margin-top:8px}
  .btn{
    position:relative;display:inline-flex;align-items:center;justify-content:center;
    gap:6px;padding:8px 12px;border-radius:999px;
    border:1px solid rgba(12,44,122,.16);
    background:linear-gradient(#fff,#F4F7FF);
    cursor:pointer;font-size:13px;
    transition:transform .1s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(12,44,122,.18)}
  .btn.gold{
    background:linear-gradient(135deg,var(--gold),var(--gold2));
    color:#111;border-color:transparent;
    box-shadow:0 10px 24px rgba(185,138,47,.32)
  }
  .btn.gold::after{
    content:"";position:absolute;inset:-120% -40% auto -40%;height:220%;
    background:linear-gradient(120deg,transparent 45%,rgba(255,255,255,.9) 50%,transparent 55%);
    animation:shine 3.2s linear infinite
  }
  @keyframes shine{to{transform:translateX(160%)}}

  /* PDP lightbox */
  .backdrop{
    position:fixed;inset:0;opacity:0;pointer-events:none;
    background:radial-gradient(1100px 700px at 50% 20%, rgba(255,255,255,.95), rgba(12,44,122,.40) 70%);
    backdrop-filter:blur(8px);transition:opacity .28s ease;z-index:40
  }
  .backdrop.show{opacity:1;pointer-events:auto}
  .modal{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;z-index:50}
  .pdp{
    position:absolute;width:min(1080px,94vw);max-height:min(88vh,900px);
    opacity:0;transform:translateZ(0);
    border-radius:var(--r);box-shadow:var(--shadow);
    background:#fff;display:grid;grid-template-columns:1fr;overflow:hidden
  }
  .pdp.show{opacity:1;pointer-events:auto}
  .pdp .strip{height:8px}
  .pdp-inner{display:grid;grid-template-columns:1fr;gap:14px;padding:16px}
  @media(min-width:980px){ .pdp-inner{grid-template-columns:1.2fr .8fr;padding:20px} }
  .pdp-media{position:relative;border-radius:18px;overflow:hidden;background:#f4f6fa;min-height:320px}
  .pdp-media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scale(1.02);transition:transform .5s ease}
  .pdp-media:hover img{transform:scale(1.04)}
  .pdp-title{
    font-family:"Playfair Display",ui-serif,Georgia,serif;
    font-size:clamp(22px,4.6vw,36px);margin:0;color:var(--blue)
  }
  .pdp-sub{color:var(--muted);margin:6px 0 0}
  .pdp-price{font-weight:800;font-size:clamp(18px,3.2vw,24px);color:var(--blue);margin-top:6px}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid rgba(12,44,122,.14);font-size:12.5px;background:#fff}
  .qty{display:flex;align-items:center;gap:8px;margin-top:12px}
  .step{width:44px;height:44px;border-radius:12px;border:1px solid rgba(12,44,122,.18);background:linear-gradient(#fff,#F4F7FF);display:grid;place-items:center;cursor:pointer}
  .tiers{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tier{border:1px dashed rgba(12,44,122,.25);border-radius:999px;padding:6px 10px;font-size:12.5px}
  .pdp-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn.close{position:absolute;top:10px;right:10px;width:40px;height:40px;border-radius:999px}

  .ghost{
    position:fixed;inset:auto;overflow:hidden;border-radius:var(--r);
    background:#fff;box-shadow:0 24px 70px rgba(12,44,122,.18);
    transform-origin:top left;will-change:transform,opacity
  }

  @media (prefers-reduced-motion: reduce){ .pdp-media img{transition:none} }

  /* Sticky Cart Widget */
  .cart-fab{
    position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:60;
    display:inline-flex;align-items:center;gap:10px;
    padding:12px 16px;border-radius:999px;
    background:radial-gradient(circle at 0 0,#ffffff, #F4F7FF);
    border:1px solid rgba(12,44,122,.18);
    box-shadow:0 16px 40px rgba(12,44,122,.24);
    cursor:pointer
  }
  .cart-fab .dot{
    min-width:22px;height:22px;border-radius:999px;
    background:linear-gradient(135deg,var(--gold),var(--gold2));
    color:#111;display:grid;place-items:center;
    font-weight:800;font-size:12px;box-shadow:0 8px 18px rgba(185,138,47,.35)
  }
  .cart-fab .meta{font-weight:700;color:var(--blue);font-size:13px}

  .drawer{
    position:fixed;left:50%;transform:translateX(-50%);bottom:-100%;
    width:min(1080px,96vw);max-height:82vh;
    background:#fff;border:1px solid rgba(12,44,122,.18);
    border-radius:22px 22px 0 0;
    box-shadow:0 -30px 120px rgba(12,44,122,.35);
    z-index:70;transition:bottom .35s cubic-bezier(.18,.9,.2,1)
  }
  .drawer.open{bottom:0}
  .drawer header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(12,44,122,.12)}
  .drawer h3{margin:0;color:var(--blue);font-size:18px}
  .drawer .close{width:36px;height:36px;border-radius:999px;border:1px solid rgba(12,44,122,.18);background:linear-gradient(#fff,#F4F7FF);cursor:pointer}
  .drawer .body{display:grid;grid-template-columns:1fr;gap:12px;padding:12px 14px;overflow:auto;max-height:calc(82vh - 130px)}
  .line{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid rgba(12,44,122,.12);border-radius:14px;padding:10px;background:#fff;box-shadow:0 10px 24px rgba(12,44,122,.12)}
  .line img{width:64px;height:64px;object-fit:cover;border-radius:10px}
  .line .name{font-weight:700;color:var(--blue);font-size:14px}
  .line .qty{display:flex;align-items:center;gap:6px}
  .pill{width:32px;height:32px;border-radius:10px;border:1px solid rgba(12,44,122,.18);background:linear-gradient(#fff,#F4F7FF);display:grid;place-items:center;cursor:pointer}
  .trash{margin-left:8px}
  .summary{display:flex;align-items:center;justify-content:space-between;border-top:1px solid rgba(12,44,122,.12);padding:12px 16px;background:#FBFCFF;border-radius:0 0 22px 22px}
  .summary .subtotal{font-weight:800;color:var(--blue)}
  .cta-row-cart{display:flex;gap:10px;flex-wrap:wrap}
  .btn.gold.sheen::after{
    content:"";position:absolute;inset:-120% -40% auto -40%;height:220%;
    background:linear-gradient(120deg,transparent 45%,rgba(255,255,255,.9) 50%,transparent 55%);
    animation:shine 3.2s linear infinite
  }

  .upsells{margin-top:6px}
  .upsells h4{margin:6px 0;color:var(--blue);font-size:16px}
  .ups-grid{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(160px,1fr);gap:10px;overflow:auto;padding-bottom:6px}
  .ups-card{border:1px solid rgba(12,44,122,.12);border-radius:14px;background:#fff;box-shadow:0 12px 26px rgba(12,44,122,.12);padding:8px}
  .ups-card img{width:100%;height:110px;object-fit:cover;border-radius:10px}
  .ups-card .nm{font-size:13px;color:var(--blue);font-weight:700;margin-top:6px}
  .ups-card .pr{font-size:13px}

  /* 24-Hour Cart Browsing Prompt */
  .prompt-backdrop{
    position:fixed;inset:0;
    background:radial-gradient(900px 600px at 50% 20%, rgba(255,255,255,.9), rgba(12,44,122,.45) 70%);
    backdrop-filter:blur(6px);opacity:0;pointer-events:none;
    transition:opacity .25s ease;z-index:80
  }
  .prompt-backdrop.show{opacity:1;pointer-events:auto}
  .prompt-modal{
    position:fixed;left:50%;top:52%;
    transform:translate(-50%,-50%) scale(.98);
    opacity:0;z-index:90;
    width:min(980px,94vw);
    background:#fff;border-radius:22px;
    border:1px solid rgba(12,44,122,.12);
    box-shadow:0 40px 120px rgba(12,44,122,.4), 0 0 0 1px rgba(230,182,82,.25);
    display:grid;grid-template-columns:1fr;
    overflow:hidden;
    transition:transform .28s cubic-bezier(.18,.9,.2,1), opacity .25s ease;
    pointer-events:none;
  }
  .prompt-modal.show{
    opacity:1;
    transform:translate(-50%,-50%) scale(1);
    pointer-events:auto;
  }
  .prompt-grid{display:grid;grid-template-columns:1fr;gap:0}
  @media(min-width:900px){ .prompt-grid{grid-template-columns:1.05fr .95fr} }
  .prompt-media{position:relative;min-height:280px;background:#f4f6fa}
  .prompt-media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}
  .prompt-body{padding:18px 18px 16px}
  .prompt-title{
    font-family:"Playfair Display",ui-serif,Georgia,serif;
    margin:0 0 6px;color:var(--blue);font-size:clamp(22px,4.8vw,34px)
  }
  .prompt-copy{color:#3b3a37;line-height:1.7;margin:0 0 10px}
  .prompt-bullets{margin:8px 0 12px;padding-left:18px;color:#4B4A46;font-size:14px}
  .prompt-form{display:grid;gap:10px}
  .prompt-form input{padding:12px 14px;border-radius:12px;border:1px solid rgba(12,44,122,.18);background:#fff;font-size:14px}
  .prompt-cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .btn.text{background:transparent;border-color:transparent;color:#2b4ca8;text-decoration:underline}
  .prompt-close{
    position:absolute;top:10px;right:10px;
    width:32px;height:32px;border-radius:999px;
    border:1px solid rgba(12,44,122,.18);
    background:linear-gradient(#fff,#F4F7FF);
    display:grid;place-items:center;
    font-size:16px;cursor:pointer;
    box-shadow:0 8px 18px rgba(12,44,122,.18);
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Thoughtful
        <span style="background:linear-gradient(110deg,var(--gold) 0%,var(--gold) 40%,#fff 50%,var(--gold) 60%,var(--gold2) 100%);-webkit-background-clip:text;background-clip:text;color:transparent;background-size:200% 100%;animation:shine 3.5s linear infinite">
          DÃ©cor
        </span>, Ready to Style
      </h1>
      <p class="lead">Curated pieces that make rooms feel calm, welcoming, and complete. Browse our bestsellers and tap a product for quick details, transparent pricing, and easy checkout.</p>
    </header>

    <!-- Search -->
    <div class="search-row">
      <input id="searchInput" class="search-input" placeholder="Search by product name or SKUâ€¦" />
    </div>

    <nav class="filters" id="filters"></nav>
    <section class="grid" id="grid">
      <!-- JS will inject products or a loading state -->
    </section>
  </div>

  <!-- PDP -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>
  <div class="modal" aria-live="polite" aria-atomic="true">
    <div class="pdp" id="pdp" role="dialog" aria-modal="true" aria-labelledby="pdptitle">
      <div class="strip" id="pdpStrip"></div>
      <button class="btn close" id="close" aria-label="Close">âœ•</button>
      <div class="pdp-inner">
        <section class="pdp-media"><img id="pdpImg" alt="Product image"></section>
        <aside>
          <h1 class="pdp-title" id="pdptitle"></h1>
          <p class="pdp-sub" id="pdpsub"></p>
          <p class="pdp-sub" id="trustline" style="margin-top:6px;color:#2A2A2A;opacity:.9">
            In stock. Island-wide delivery or Knutsford pickup.
          </p>
          <div class="pdp-price" id="pdpprice"></div>
          <div class="badges" id="pdpbadges"></div>
          <div class="qty">
            <button class="step" id="minus">âˆ’</button>
            <div id="qty">1</div>
            <button class="step" id="plus">+</button>
          </div>
          <div class="tiers" id="pdptiers"></div>
          <div class="pdp-cta">
            <button class="btn gold" id="add">Add to Cart</button>
            <button class="btn" id="buy">Order Now</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Sticky Cart Widget -->
  <button class="cart-fab" id="cartFab" aria-expanded="false" aria-controls="cartDrawer">
    <span class="dot" id="cartCount">0</span>
    <span class="meta" id="cartMeta">Your Cart</span>
  </button>

  <section class="drawer" id="cartDrawer" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <header>
      <h3 id="cartTitle">Your Cart</h3>
      <button class="close" id="cartClose" aria-label="Close cart">âœ•</button>
    </header>
    <div class="body" id="cartBody"></div>
    <div class="upsells">
      <div class="wrap" style="padding:0 14px 10px">
        <h4>Complete the Look</h4>
        <div class="ups-grid" id="upsGrid"></div>
      </div>
    </div>
    <div class="summary">
      <div class="subtotal" id="cartSubtotal">Subtotal â€” JMD 0</div>
      <div class="cta-row-cart">
        <button class="btn" id="keepShopping">Keep Shopping</button>
        <button class="btn gold sheen" id="checkout">Checkout</button>
      </div>
    </div>
  </section>

  <!-- 24-Hour Cart Browsing Prompt -->
  <div class="prompt-backdrop" id="promptBackdrop"></div>
  <section class="prompt-modal" id="promptModal" role="dialog" aria-modal="true" aria-labelledby="promptTitle">
    <button type="button" class="prompt-close" id="promptClose" aria-label="Close save cart popup">âœ•</button>

    <div class="prompt-grid">
      <figure class="prompt-media" aria-hidden="true">
        <img id="promptImg" src="PROMPT_IMG_URL" alt="" />
      </figure>
      <div class="prompt-body">
        <h2 class="prompt-title" id="promptTitle">Save Your 24-Hour Cart</h2>
        <p class="prompt-copy">Keep items you love while you browse. Weâ€™ll hold your cart for 24 hours and send your coupons to your inbox.</p>
        <ul class="prompt-bullets">
          <li>Quick save â€” no commitment</li>
          <li>Compare pieces and check out later</li>
          <li>Island-wide delivery or Knutsford pickup</li>
        </ul>
        <form class="prompt-form" id="promptForm" novalidate>
          <input id="pName"  name="name"  placeholder="Cart name (e.g., Living Room Refresh)" required />
          <input id="pEmail" name="email" type="email" placeholder="Email" required />
          <input id="pPhone" name="phone" inputmode="tel" placeholder="Phone" required />
          <div class="prompt-cta">
            <button type="submit" class="btn gold sheen" id="promptSave">Save My Cart</button>
            <button type="button" class="btn text" id="promptLater">Not now</button>
          </div>
        </form>
        <small class="pdp-sub" style="display:block;margin-top:8px;color:#707070">You can opt out anytime. We respect your privacy.</small>
      </div>
    </div>
  </section>

<script>
// ================== CONFIG ==================
// Existing exec â€“ still used for cart save / leads etc.
const EXEC_URL =
'https://script.google.com/macros/s/AKfycbyuKVdjwz25nESKmFt3Wgbf_rWT6UCeVgUvSKVBziQYgiItNcwq2m1LWsQQWt0Xu-JfSA/exec';

// Inventory exec â€“ this is the web app with the new Code.gs (inventoryProducts action)
const INVENTORY_EXEC =
'https://script.google.com/macros/s/AKfycbxE2EhcpxgdWBeF9t5VuNJZ4GAqbBLxUDOhn6KWRB8fUfeSx3e_Y3P_8r5OHeYhGzptcA/exec';

// âœ… Cloud Run payment handoff (set this to your deployed Cloud Run base URL)
// Example: https://fiserv-cloudrun-xxxxx-uc.a.run.app
const CLOUDRUN_BASE_URL = 'PASTE_YOUR_CLOUDRUN_URL_HERE';
const PAYMENT_START_PATH = '/start-payment';

// Currency mapping:
// If you're charging in JMD through Fiserv, the numeric code is typically 388.
// If you are charging in USD, use 840.
const PAYMENT_CURRENCY_CODE = '388';

// Category labels for filter chips
const CATEGORY_LABELS = [
  'All DÃ©cor',
  'Lamps & Lighting',
  'Mirrors & Wall Art',
  'Vases & Florals',
  'Tabletop & Accents',
  'Furniture & Large Pieces',
  'Other'
];

// Strip colors per category
const CATEGORY_STRIPS = {
  'Lamps & Lighting':'#0F6ABF',
  'Mirrors & Wall Art':'#6E3AA6',
  'Vases & Florals':'#B98A2F',
  'Tabletop & Accents':'#8C4A2F',
  'Furniture & Large Pieces':'#007E62',
  'Other':'#4B4A46',
  'All DÃ©cor':'#0C2C7A'
};

const $  = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const PR = new Intl.NumberFormat('en-JM',{style:'currency',currency:'JMD',maximumFractionDigits:0});

// Fallback mock products (with example images) in case API fails
const FALLBACK_DATA = [
  {
    sku:'EC-001',
    name:'Sculptural Gold Lamp',
    price:18950,
    img:'https://images.pexels.com/photos/1571470/pexels-photo-1571470.jpeg',
    desc:'Warm metallic glow that elevates any room. Built to last.',
    cat:'Lamps & Lighting',
    badges:['Bestseller'],
    tiers:[{min:3,pct:5},{min:5,pct:10}]
  },
  {
    sku:'EC-002',
    name:'Beveled Brass Mirror',
    price:32950,
    img:'https://images.pexels.com/photos/1457841/pexels-photo-1457841.jpeg',
    desc:'Crisp beveled edge with a soft brass finish. Durable for everyday use.',
    cat:'Mirrors & Wall Art',
    badges:['Featured'],
    tiers:[{min:3,pct:5},{min:5,pct:10}]
  },
  {
    sku:'EC-003',
    name:'Textured Stone Vase',
    price:9950,
    img:'https://images.pexels.com/photos/1080696/pexels-photo-1080696.jpeg',
    desc:'Soft, textured finish that adds depth without clutter.',
    cat:'Vases & Florals',
    badges:[],
    tiers:[{min:3,pct:5}]
  },
  {
    sku:'EC-004',
    name:'Ambient Wall Sconce',
    price:25950,
    img:'https://images.pexels.com/photos/1571460/pexels-photo-1571460.jpeg',
    desc:'Ambient glow for cozy eveningsâ€”sleek, modern shape.',
    cat:'Lamps & Lighting',
    badges:['Limited Stock'],
    tiers:[{min:3,pct:5},{min:5,pct:10}]
  }
];

let DATA = [];                 // all products
let CURRENT_CATEGORY = 'All DÃ©cor';
let CURRENT_QUERY = '';

const grid = $('#grid');
const searchInput = $('#searchInput');

// ======== PAYMENT HELPERS (NEW) ========
function normalizeAmount2dp(n){
  const x = Number(n);
  if(!Number.isFinite(x) || x <= 0) return '0.00';
  return x.toFixed(2);
}

function getCartSubtotal(){
  return CART.items.reduce((s,i)=>s + (Number(i.price)||0) * (Number(i.qty)||0), 0);
}

function getOwner(){
  try{
    return JSON.parse(localStorage.getItem(LS_KEY_OWNER) || 'null');
  }catch(_){
    return null;
  }
}

function getCartId(){
  const existing = localStorage.getItem('ec_cart_id');
  if(existing) return existing;
  const id = `cart_${Date.now()}`;
  localStorage.setItem('ec_cart_id', id);
  return id;
}

function buildStartPaymentUrl({ amount, currency, oid, email }){
  const base = (CLOUDRUN_BASE_URL || '').trim().replace(/\/+$/,'');
  if(!base || base.includes('PASTE_YOUR_CLOUDRUN_URL_HERE')) return '';
  const u = new URL(base + PAYMENT_START_PATH);
  u.searchParams.set('amount', normalizeAmount2dp(amount));
  u.searchParams.set('currency', String(currency || PAYMENT_CURRENCY_CODE || '388'));
  u.searchParams.set('oid', String(oid || getCartId()));
  // extra fields are safe even if server ignores them
  if(email) u.searchParams.set('email', String(email));
  return u.toString();
}

function redirectToPayment(startUrl){
  // If not embedded, redirect directly
  if(window.top === window.self){
    window.location.href = startUrl;
    return;
  }
  // Embedded: ask parent to redirect the top window
  emit('checkout:redirect', { url: startUrl });
  // Fallback attempt (some parents allow it)
  try{ window.top.location.href = startUrl; }catch(_){}
}

// ======== HELPERS ========

function deriveCategory(name){
  const n = (name || '').toUpperCase();
  if(n.includes('LAMP') || n.includes('LIGHT') || n.includes('SCONCE')) return 'Lamps & Lighting';
  if(n.includes('MIRROR') || n.includes('FRAME') || n.includes('ART')) return 'Mirrors & Wall Art';
  if(n.includes('VASE') || n.includes('FLORAL') || n.includes('FLOWER')) return 'Vases & Florals';
  if(n.includes('TABLETOP') || n.includes('FIGURE') || n.includes('FIGURINE') || n.includes('DECOR')) return 'Tabletop & Accents';
  if(n.includes('CHAIR') || n.includes('SOFA') || n.includes('TABLE ') || n.includes('STOOL')) return 'Furniture & Large Pieces';
  return 'Other';
}

/**
 * Convert whatever we get from the backend into a real image URL.
 * Supports:
 *  - bare Drive file IDs
 *  - Drive share links (/file/d/ID/, ?id=ID)
 *  - already-clean URLs (left as-is)
 */
function buildImageUrl(rawImg){
  if(!rawImg) return '';
  let v = String(rawImg).trim();
  if(!v) return '';

  // If it's already some kind of URL
  if(v.startsWith('http')){
    // Try to extract a Google Drive file ID if present
    const m1 = v.match(/\/d\/([a-zA-Z0-9_-]+)/);
    const m2 = v.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    const id = (m1 && m1[1]) || (m2 && m2[1]);

    // If we found a Drive ID, return a clean "uc" link; otherwise use the URL as-is
    return id ? `https://drive.google.com/uc?export=view&id=${id}` : v;
  }

  // If it's not a URL, treat it as a bare file ID
  return `https://drive.google.com/uc?export=view&id=${v}`;
}

function normalizeProduct(raw){
  const name = raw.name || raw.item_name || '';
  const cat  = raw.category || raw.category_name || raw.webCategory || deriveCategory(name);

  // Accept multiple possible fields from Apps Script
  const rawImg =
    raw.image ||
    raw.image_url ||
    raw.item_image ||
    raw.imageUrl ||
    raw.image_file_id ||
    raw.imageFileId ||
    '';

  const img = buildImageUrl(rawImg);

  return {
    sku   : raw.sku || raw.SKU || raw.item_id || raw.id || '',
    name  : name || 'Untitled Item',
    price : Number(raw.price || raw.sellingPrice || raw.rate || raw.unit_price || 0),
    img   : img,
    desc  : raw.description || '',
    cat   : cat || 'Other',
    badges: raw.badges || [],
    tiers : raw.tiers || []
  };
}

// ======== FETCH PRODUCTS FROM APPS SCRIPT ========
async function loadProducts(){
  grid.innerHTML = '<div class="grid-empty">Loading your dÃ©cor selectionâ€¦</div>';

  try{
    const url = INVENTORY_EXEC + '?action=inventoryProducts';
    const res = await fetch(url, { method:'GET' });
    if(!res.ok) throw new Error('Network error: '+res.status);
    const json = await res.json();
    const rawList = Array.isArray(json) ? json : (json.products || []);
    if(!rawList.length) throw new Error('No products from API');
    DATA = rawList.map(normalizeProduct);
  }catch(err){
    console.error('Inventory API failed, using fallback products:', err);
    DATA = FALLBACK_DATA;
  }

  buildFilters();
  applyFilters();
  renderCart();
  sendHeight();
}

// ======== FILTERS, SEARCH, GRID ========

function buildFilters(){
  const fbar = $('#filters');
  fbar.innerHTML = '';

  if(!DATA.length) return;

  CATEGORY_LABELS.forEach(label => {
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = label;
    b.dataset.filter = label;
    b.setAttribute('aria-pressed', label === CURRENT_CATEGORY ? 'true' : 'false');
    b.onclick = () => {
      CURRENT_CATEGORY = label;
      $$('#filters .chip').forEach(c => c.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      applyFilters();
    };
    fbar.appendChild(b);
  });
}

function applyFilters(){
  let list = DATA.slice();

  if(CURRENT_CATEGORY && CURRENT_CATEGORY !== 'All DÃ©cor'){
    list = list.filter(p => p.cat === CURRENT_CATEGORY);
  }

  if(CURRENT_QUERY){
    const q = CURRENT_QUERY;
    list = list.filter(p =>
      (p.name || '').toLowerCase().includes(q) ||
      (p.sku || '').toLowerCase().includes(q)
    );
  }

  renderGrid(list);
}

searchInput.addEventListener('input', () => {
  CURRENT_QUERY = searchInput.value.toLowerCase().trim();
  applyFilters();
});

function renderGrid(list){
  grid.innerHTML = '';
  if(!list.length){
    grid.innerHTML = '<div class="grid-empty">No items match this search yet. Try another term or category.</div>';
    return;
  }

  list.forEach(p => {
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.sku = p.sku;

    const hasImg = !!p.img;

    card.innerHTML = `
      <div class="thumb${hasImg ? '' : ' placeholder'}">
        <div class="strip" style="background:${CATEGORY_STRIPS[p.cat]||'#0C2C7A'}"></div>
        ${hasImg
          ? `<img src="${p.img}" alt="${p.name}" loading="lazy">`
          : `<span>Image coming soon</span>`}
      </div>
      <div class="body">
        <div class="name">${p.name}</div>
        <div class="price">${PR.format(p.price)}</div>
        <div class="cta-row">
          <button class="btn view">Quick View</button>
        </div>
      </div>`;

    grid.appendChild(card);
    card.querySelector('.view').onclick = e => { e.stopPropagation(); openPDP(p,card); };
    card.addEventListener('click', e => {
      if(!(e.target.classList.contains('view'))) openPDP(p,card);
    });
  });
}

// ======== PDP LOGIC ========
let ACTIVE = null, QTY = 1, PROD = null;
const backdrop = $('#backdrop'), pdp = $('#pdp'), strip = $('#pdpStrip');
const img = $('#pdpImg'), title = $('#pdptitle'), sub = $('#pdpsub'),
      priceEl = $('#pdpprice'), badgesEl = $('#pdpbadges'), tiersEl = $('#pdptiers');

$('#plus').onclick  = () => { QTY++; $('#qty').textContent = QTY; };
$('#minus').onclick = () => { QTY = Math.max(1,QTY-1); $('#qty').textContent = QTY; };
$('#add').onclick   = () => { if(PROD) emit('pdp:addToCart',{ sku:PROD.sku, qty:QTY }); closePDP(); };
$('#buy').onclick   = () => { if(PROD) emit('pdp:buyNow',{ sku:PROD.sku, qty:QTY }); };
$('#close').onclick = closePDP;
backdrop.onclick    = closePDP;
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closePDP(); });

function openPDP(p,card){
  PROD = p;
  ACTIVE = card;
  QTY = 1;
  $('#qty').textContent = QTY;

  if(p.img){
    img.src = p.img;
  }else{
    img.removeAttribute('src');
  }
  title.textContent = p.name;
  sub.textContent = p.desc || '';
  priceEl.textContent = PR.format(p.price);
  badgesEl.innerHTML = (p.badges||[]).map(b=>`<span class="badge">${b}</span>`).join('');
  tiersEl.innerHTML  = (p.tiers||[]).map(t=>`<span class="tier">${t.min}+ save ${t.pct}%</span>`).join('');
  strip.style.background = CATEGORY_STRIPS[p.cat] || '#0C2C7A';

  // Clean up any old ghosts first
  document.querySelectorAll('.ghost').forEach(g => g.remove());

  const r = card.getBoundingClientRect();
  const ghost = document.createElement('div');
  ghost.className = 'ghost';
  ghost.style.left   = r.left + 'px';
  ghost.style.top    = r.top + 'px';
  ghost.style.width  = r.width + 'px';
  ghost.style.height = r.height + 'px';
  document.body.appendChild(ghost);

  requestAnimationFrame(()=>{
    backdrop.classList.add('show');
    pdp.classList.add('show');
    const rr = pdp.getBoundingClientRect();
    const sx = r.width/rr.width, sy = r.height/rr.height;
    const dx = r.left-rr.left,   dy = r.top-rr.top;
    pdp.style.opacity = 0;
    pdp.style.transformOrigin = 'top left';
    pdp.style.transform = `translate(${dx}px,${dy}px) scale(${sx},${sy})`;
    requestAnimationFrame(()=>{
      pdp.style.transition = `transform .36s cubic-bezier(.18,.9,.2,1), opacity .2s ease`;
      pdp.style.opacity = 1;
      pdp.style.transform = 'translate(0,0) scale(1,1)';
      ghost.style.opacity = 0;
      ghost.style.transition = 'opacity .2s ease';
      setTimeout(()=>{
        ghost.remove();
        pdp.style.transition = '';
        pdp.style.transform = '';
      }, 400);
    });
  });
}

function closePDP(){
  if(!pdp.classList.contains('show')) return;

  const origin = ACTIVE || document.querySelector(`[data-sku="${PROD?.sku}"]`);
  const rr = pdp.getBoundingClientRect();
  backdrop.classList.remove('show');

  if(origin){
    const r  = origin.getBoundingClientRect();
    const sx = r.width/rr.width, sy = r.height/rr.height;
    const dx = r.left-rr.left,   dy = r.top-rr.top;
    pdp.style.transition = `transform .3s cubic-bezier(.18,.9,.2,1), opacity .2s ease`;
    pdp.style.transformOrigin = 'top left';
    pdp.style.transform = `translate(${dx}px,${dy}px) scale(${sx},${sy})`;
    pdp.style.opacity = 0;
    setTimeout(()=>{
      pdp.classList.remove('show');
      pdp.style.transition = '';
      pdp.style.transform  = '';
      pdp.style.opacity    = 1;
      ACTIVE = null;
      PROD = null;
      document.querySelectorAll('.ghost').forEach(g => g.remove());
    }, 320);
  }else{
    pdp.classList.remove('show');
    ACTIVE = null;
    PROD = null;
    document.querySelectorAll('.ghost').forEach(g => g.remove());
  }
}

// ======== POSTMESSAGE / HEIGHT ========
function emit(type,payload){
  try{ parent.postMessage({type,payload},'*'); }catch(_){}
}

function sendHeight(){
  try{
    parent.postMessage({type:'ui:height', payload:{ px: document.documentElement.scrollHeight }}, '*');
  }catch(_){}
}
new ResizeObserver(sendHeight).observe(document.documentElement);
window.addEventListener('load', sendHeight);

// ======== CART WIDGET ========
let CART = { items: [] };
const cartFab      = $('#cartFab'),
      cartDrawer   = $('#cartDrawer'),
      cartBody     = $('#cartBody'),
      cartCount    = $('#cartCount'),
      cartMeta     = $('#cartMeta'),
      cartSubtotal = $('#cartSubtotal');
const cartClose = $('#cartClose'),
      keepShopping = $('#keepShopping'),
      checkoutBtn  = $('#checkout');

cartFab.onclick      = ()=>{ const open=!cartDrawer.classList.contains('open'); setCartOpen(open); };
cartClose.onclick    = ()=>setCartOpen(false);
keepShopping.onclick = ()=>setCartOpen(false);

function setCartOpen(open){
  cartDrawer.classList.toggle('open',open);
  cartFab.setAttribute('aria-expanded', String(open));
}

function addToCart(item, qty){
  const i = CART.items.findIndex(x=>x.sku===item.sku);
  if(i>=0) CART.items[i].qty += qty;
  else CART.items.push({ sku:item.sku, name:item.name, price:item.price, image:item.img, qty });
  renderCart();
  emit('pdp:addToCart',{ sku:item.sku, qty });
}
function removeFromCart(sku){
  CART.items = CART.items.filter(x=>x.sku!==sku);
  renderCart();
  emit('cart:remove',{ sku });
}
function setQty(sku, qty){
  const it = CART.items.find(x=>x.sku===sku);
  if(!it) return;
  it.qty = Math.max(1,qty);
  renderCart();
  emit('cart:updateQty',{ sku, qty:it.qty });
}

function renderCart(){
  const subtotal = getCartSubtotal();
  cartCount.textContent   = String(CART.items.reduce((s,i)=>s+i.qty,0));
  cartMeta.textContent    = CART.items.length ? 'View Cart' : 'Your Cart';
  cartSubtotal.textContent= `Subtotal â€” ${PR.format(subtotal)}`;
  cartBody.innerHTML = '';

  CART.items.forEach(i=>{
    const row = document.createElement('div');
    row.className = 'line';
    const hasImg = !!i.image;
    row.innerHTML = `
      ${hasImg ? `<img src="${i.image}" alt="${i.name}">` : `<div style="width:64px;height:64px;border-radius:10px;background:radial-gradient(circle at 0 0, rgba(230,182,82,.3), rgba(12,44,122,.08));display:grid;place-items:center;font-size:10px;color:#555;">No image</div>`}
      <div>
        <div class="name">${i.name}</div>
        <div class="pr">${PR.format(i.price)}</div>
      </div>
      <div class="qty">
        <button class="pill" aria-label="Decrease" data-act="-">âˆ’</button>
        <div>${i.qty}</div>
        <button class="pill" aria-label="Increase" data-act="+">+</button>
        <button class="pill trash" aria-label="Remove">ðŸ—‘</button>
      </div>`;
    cartBody.appendChild(row);

    const [dec, , inc, del] = row.querySelectorAll('.pill');
    dec.onclick = ()=>setQty(i.sku, i.qty-1);
    inc.onclick = ()=>setQty(i.sku, i.qty+1);
    del.onclick = ()=>removeFromCart(i.sku);
  });

  const have = new Set(CART.items.map(i=>i.sku));
  const picks = (DATA||[]).filter(p=>!have.has(p.sku)).slice(0,3);
  const ups = $('#upsGrid');
  ups.innerHTML = '';
  picks.forEach(p=>{
    const c = document.createElement('div');
    c.className = 'ups-card';
    const hasImg = !!p.img;
    c.innerHTML = `
      ${hasImg ? `<img src="${p.img}" alt="${p.name}">` : `<div style="width:100%;height:110px;border-radius:10px;background:radial-gradient(circle at 0 0, rgba(230,182,82,.3), rgba(12,44,122,.08));display:grid;place-items:center;font-size:10px;color:#555;">No image</div>`}
      <div class="nm">${p.name}</div>
      <div class="pr">${PR.format(p.price)}</div>
      <button class="btn" style="margin-top:6px">Add</button>`;
    ups.appendChild(c);
    c.querySelector('.btn').onclick = ()=>addToCart(p,1);
  });
}

// Ensure PDP addToCart also hits our local cart
const _emit = emit;
emit = (type,payload)=>{
  try{ _emit(type,payload); }catch(_){}
  if(type==='pdp:addToCart'){
    const p = DATA.find(x=>x.sku===payload.sku);
    if(p && payload.qty>0){
      addToCart(p,payload.qty);
      setCartOpen(true);
    }
  }
  if(type==='pdp:buyNow'){
    setCartOpen(true);
  }
};

function onMessageCart(e){
  const {type,payload} = e.data || {};
  if(type==='state:cart'){
    CART.items = (payload.items||[]).map(i=>({
      sku:i.sku, name:i.name, price:i.price, qty:i.qty, image:i.image
    }));
    renderCart();
  }
}
window.addEventListener('message', onMessageCart);

// âœ… Checkout: keep existing emit, PLUS start payment handoff with exact subtotal (NEW)
checkoutBtn.onclick = ()=>{
  const subtotal = getCartSubtotal();
  const owner = getOwner();
  const cartId = getCartId();

  // Always emit (keeps your existing parent integration intact)
  emit('cart:checkout', {
    items: CART.items,
    subtotal,
    currency: 'JMD',
    currencyCode: PAYMENT_CURRENCY_CODE,
    cartId,
    owner: owner ? { name: owner.name || '', email: owner.email || '', phone: owner.phone || '' } : null
  });

  // If cart is empty, donâ€™t proceed
  if(!CART.items.length || subtotal <= 0){
    alert('Your cart is empty. Add an item first.');
    return;
  }

  // Build Cloud Run start-payment URL (amount + oid + optional email)
  const startUrl = buildStartPaymentUrl({
    amount: subtotal,
    currency: PAYMENT_CURRENCY_CODE,
    oid: cartId,
    email: owner && owner.email ? owner.email : ''
  });

  if(!startUrl){
    alert('Checkout is not configured yet. Please set CLOUDRUN_BASE_URL in this iframe file.');
    return;
  }

  // Redirect (or ask parent to redirect if embedded)
  redirectToPayment(startUrl);
};

renderCart();

// ======== 24-HOUR CART PROMPT (same behaviour as before) ========
const LS_KEY_OWNER = 'ec_cart_owner';
const LS_KEY_NEXT  = 'ec_cart_prompt_next_at';
const MIN          = 60 * 1000;
const INITIAL_DELAY= 45 * MIN;
const REPEAT_DELAY = 45 * MIN;

const promptBackdrop = $('#promptBackdrop');
const promptModal    = $('#promptModal');
const promptClose    = $('#promptClose');

function hasOwner(){
  try{
    const o = JSON.parse(localStorage.getItem(LS_KEY_OWNER) || 'null');
    return !!(o && o.name && o.email);
  }catch(_){
    return false;
  }
}
function scheduleNext(ms){
  localStorage.setItem(LS_KEY_NEXT, String(Date.now()+ms));
}
function nextDue(){
  const v = Number(localStorage.getItem(LS_KEY_NEXT) || 0);
  return Date.now() >= v;
}
function showPrompt(){
  if(hasOwner()) return;
  promptBackdrop.classList.add('show');
  promptModal.classList.add('show');
}
function hidePrompt(){
  promptBackdrop.classList.remove('show');
  promptModal.classList.remove('show');
}

function tryPrompt(){
  if(hasOwner()) return;
  if(!localStorage.getItem(LS_KEY_NEXT)){
    scheduleNext(INITIAL_DELAY);
  }
  const tick = ()=>{
    if(hasOwner()) return;
    if(nextDue()){
      showPrompt();
    }else{
      setTimeout(tick, 1500);
    }
  };
  setTimeout(tick, 1200);
}

promptBackdrop.addEventListener('click', ()=>{
  hidePrompt();
  scheduleNext(REPEAT_DELAY);
});
document.addEventListener('keydown',(e)=>{
  if(e.key === 'Escape' && promptModal.classList.contains('show')){
    hidePrompt();
    scheduleNext(REPEAT_DELAY);
  }
});
promptClose.addEventListener('click', ()=>{
  hidePrompt();
  scheduleNext(REPEAT_DELAY);
});

function onMessagePrompt(e){
  const {type,payload} = e.data || {};
  if(type==='state:cart'){
    if(payload && (payload.name || payload.email)){
      localStorage.setItem(LS_KEY_OWNER, JSON.stringify({
        name : payload.name  || '',
        email: payload.email || '',
        phone: payload.phone || ''
      }));
    }
  }
}
window.addEventListener('message', onMessagePrompt);

$('#promptLater').onclick = ()=>{
  hidePrompt();
  scheduleNext(REPEAT_DELAY);
};

const promptForm = $('#promptForm');
promptForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name  = $('#pName').value.trim();
  const email = $('#pEmail').value.trim();
  const phone = $('#pPhone').value.trim();
  if(!name || !email || !phone) return;

  const cartId = localStorage.getItem('ec_cart_id') || `cart_${Date.now()}`;
  localStorage.setItem('ec_cart_id', cartId);

  localStorage.setItem(LS_KEY_OWNER, JSON.stringify({name,email,phone}));

  emit('cart:saveOwner', { cartId, name, email, phone });

  try{
    if(EXEC_URL){
      await fetch(EXEC_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          event:'cartSaved',
          site:'exclusivecomfortdecor',
          cartId,
          name,
          email,
          phone,
          items: CART.items || [],
          ts: Date.now()
        })
      });
    }
  }catch(_){}

  hidePrompt();
});

// ======== INIT ========
window.addEventListener('load', ()=>{
  loadProducts();
  tryPrompt();
});
</script>
</body>
</html>
